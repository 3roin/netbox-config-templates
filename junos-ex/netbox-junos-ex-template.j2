{#- **************************************************
###           System configuration               ###
**************************************************#}
{%- if device.virtual_chassis %}
groups {
    member0 {
        system {
            host-name {% for node in device.virtual_chassis.members.all() %}{%- if node.vc_position == 0 %}{{ node.name }}{%- endif %}{%- endfor %};
        }
    }
    member1 {
        system {
            host-name {% for node in device.virtual_chassis.members.all() %}{%- if node.vc_position == 1 %}{{ node.name }}{%- endif %}{%- endfor %};
        }
    }
}
apply-groups [ member0 member1 ];
{%- endif %}
system {
    {%- if device.virtual_chassis %}
    commit synchronize;
    {%- else %}
    host-name {{ device.name }};
    {%- endif %}
    root-authentication {
        encrypted-password "{{ device.cf.root_password }}";
    }
    login {
        idle-timeout {{ device.cf.idle_timeout | string }};
    }
    services {
        ssh {
            root-login allow;
            protocol-version v2;
        }
        netconf {
            ssh {
                port {{ device.cf.netconf_port | string }};
            }
        }
    }
    syslog {
        user * {
            any emergency;
        }
        file interactive-commands {
            interactive-commands any;
        }
        file messages {
            any notice;
            authorization info;
        }
    }
}
{#- **************************************************
###           Chassis configuration              ###
**************************************************#}
chassis {
    {%- if device.virtual_chassis %}
    redundancy {
        graceful-switchover;
    }
    {%- endif %}
    aggregated-devices {
        ethernet {
            device-count {{ device.cf.agg_dev_count | string }};
        }
    }
    alarm {
        management-ethernet {
            link-down ignore;
        }
    }
}
{#- **************************************************
###               VC configuration               ###
**************************************************#}
{%- if device.virtual_chassis %}
virtual-chassis {
    preprovisioned;
    {%- if device.virtual_chassis.members.all() | length == 2 %}
    no-split-detection;
    {%- endif %}
    {%- for node in device.virtual_chassis.members.all() %}
    member {{ node.vc_position }} {
        {%- if node.cf.vc_role == "RE" %}
        role routing-engine;
        {%- else %}
        role line-card;
        {%- endif %}
        serial-number {{ node.serial }};
    }
    {%- endfor %}
}
{%- endif %}
{#- **************************************************
###           Interfaces configuration           ###
**************************************************#}
{%- macro ifs_config(interfaces) %}
{%- for interface in interfaces %}
{%- set fhrp_enabled = true if interface.fhrp_group_assignments.all()|length > 0 %}
{%- set ifname = interface.name.split('.')|first %}
{%- set unit_id = interface.name.split('.')|last if '.' in interface.name else None %}
{%- set count_ipaddr = interface.ip_addresses.all()|length %}
{%- set lag_member = interface.lag != None %}
{%- set lag_agg = interface.type == "lag" %}
{%- set has_tagged_vlans = interface.tagged_vlans != None and 'tagged' in interface.mode %}
{%- set is_access_mode = interface.mode == 'access' %}
    {{ ifname }} {
        {%- if not interface.enabled %}
        disable;
        {%- endif %}
        {%- if '.' not in interface.name %}
        description "{{ interface.description | default("Missing description", true) }}";
        {%- endif %}
        {%- if lag_agg %}
        aggregated-ether-options {
            lacp {
                active;
            }
            minimum-links 1;
        }
        {%- endif %}
        {%- if count_ipaddr > 0 %}
        {%- if '.' in interface.name %}
        unit {{ unit_id or 0 }} {
            description "{{ interface.description | default("Missing description", true) }}"
        {%- else %}
        unit 0 {
        {%- endif %}
            family inet {
                {%- for ipaddr in interface.ip_addresses.all() %}
                {%- if fhrp_enabled and ipaddr.role == "vrrp" %}
                address {{ ipaddr }} {
                    {%- for gr in interface.fhrp_group_assignments.all() %}
                    vrrp-group {{ gr.group.group_id }} {
                        {%- for vip in gr.group.ip_addresses.all() %}
                        virtual-address {{ (vip|string).split('/')|first }};
                        {%- endfor %}
                        priority {{ gr.priority }};
                        accept-data;
                        preempt {
                            hold-time 180;
                        }
                    }
                    {%- endfor %}
                }
                {%- else %}
                address {{ ipaddr }};
                {%- endif %}
                {%- endfor %}
            }
        }
        {%- elif lag_member %}
        gigether-options {
            802.3ad {
                {{ interface.lag.name }};
            }
        }
        {%- elif has_tagged_vlans %}
        {%- if interface.untagged_vlan != None %}
        native-vlan-id {{ interface.untagged_vlan.vid }};
        {%- endif %}
        unit 0 {
            family ethernet-switching {
            {%- if interface.mode == 'tagged' %}
                interface-mode trunk;
                vlan {
                    members [ {% for vlan in interface.tagged_vlans.all() %}{{ vlan.vid }} {% endfor %}];
                }
            {%- elif 'tagged-all' in interface.mode %}
                interface-mode trunk;
                vlan {
                    members all;
                }
            {%- endif %}
            }
        }
        {%- elif is_access_mode %}
        unit 0 {
            family ethernet-switching {
                interface-mode access;
                vlan {
                    members {{ interface.untagged_vlan.vid }};
                }
            }
        }
        {%- else %}
        unit 0;
        {%- endif %}
    }
    {%- endfor %}
{%- endmacro %}
interfaces {
{%- if device.virtual_chassis != None %}
{%- for node in device.virtual_chassis.members.all() %}
{{ ifs_config(node.interfaces.all()) }}
{%- endfor %}
{%- else %}
{{ ifs_config(device.interfaces.all()) }}
{%- endif %}
}
{#- **************************************************
###              VLANs configuration             ###
**************************************************#}
vlans {
    default {
        vlan-id 1;
    }
    {%- for vl in device.site.vlans.all() %}
    VL_{{ vl.name }} {
        vlan-id {{ vl.vid }};
        {%- for interface in device.interfaces.all() %}
        {%- if "irb" in interface.name %}
        {%- set unit_id = interface.name.split('.')|last|int if '.' in interface.name else None %}
        {%- if unit_id == vl.vid %}
        l3-interface {{ interface.name }};
        {%- endif %}
        {%- endif %}
        {%- endfor %}
    }
    {%- endfor %}
}
{#- **************************************************
###          Routing-options configuration       ###
**************************************************#}
routing-options {
    forwarding-table {
        export lb;
    }
    {%- if device.virtual_chassis %}
    nonstop-routing;
    {%- endif %}
    {%- if device.cf.static_routes != None %}
    {%- for vrf, routes in device.cf.static_routes.vrfs.items() %}
    {%- if vrf == "default" %}
    static {
        {%- for dest, next_hops in routes.dests.items() %}
        route {{ dest }} {
            {%- for nh, props in next_hops.nhs.items() %}
            {%- if not props["qualified"] %}
            next-hop {{ nh }};
            {%- else %}
            qualified-next-hop {{ nh }} {
                {%- if props["metric"] != "default" %}
                metric {{ props["metric"] }};
                {%- endif %}
                {%- if props["preference"] != "default" %}
                preference {{ props["preference"] }};
                {%- endif %}
            }
            {%- endif %}
            {%- endfor %}
        }
        {%- endfor %}
    }
    {%- endif %}
    {%- endfor %}
    {%- endif %}
}
{#- **************************************************
###          Policy-options configuration       ###
**************************************************#}
policy-options {
    policy-statement lb {
        then {
            load-balance per-packet;
        }
    }
}
{#- **************************************************
###          Protocols configuration       ###
**************************************************#}
protocols {
    {%- if device.virtual_chassis %}
    layer2-control {
        nonstop-bridging;
    }
    {%- endif %}
}
{#- **************************************************
###                VRF configuration             ###
**************************************************#}
{%- set instances = device.interfaces.all() | selectattr("vrf.name", "defined") | map(attribute="vrf.name") | unique | list %}
{%- if instances | length > 0 %}
routing-instances {
    {%- for instance in instances %}
    {{ instance }} {
        instance-type virtual-router;
        {%- if device.virtual_chassis != None %}
        {%- for node in device.virtual_chassis.members.all() %}
        {%- for interface in node.interfaces.all() %}
        {%- if interface.vrf.name == instance %}
        interface {{ interface.name }};
        {%- endif %}
        {%- endfor %}
        {%- endfor %}
        {%- else %}
        {%- for interface in device.interfaces.all() %}
        {%- if interface.vrf.name == instance %}
        interface {{ interface.name }};
        {%- endif %}
        {%- endfor %}
        {%- endif %}
        {%- if device.cf.static_routes != None %}
        routing-options {
        {%- for vrf, routes in device.cf.static_routes.vrfs.items() %}
        {%- if vrf == instance %}
            static {
                {%- for dest, next_hops in routes.dests.items() %}
                route {{ dest }} {
                    {%- for nh, props in next_hops.nhs.items() %}
                    {%- if not props["qualified"] %}
                    next-hop {{ nh }};
                    {%- else %}
                    qualified-next-hop {{ nh }} {
                        {%- if props["metric"] != "default" %}
                        metric {{ props["metric"] }};
                        {%- endif %}
                        {%- if props["preference"] != "default" %}
                        preference {{ props["preference"] }};
                        {%- endif %}
                    }
                    {%- endif %}
                    {%- endfor %}
                }
                {%- endfor %}
            }
        {%- endif %}
        {%- endfor %}
        {%- endif %}
        }
    {%- endfor %}
    }
}
{%- endif %}
{#- **************************************************
###                Forwarding options              ###
**************************************************#}
forwarding-options {
    {%- if storm_control_profiles %}
    {%- for scp in storm_control_profiles %}
    storm-control-profiles {{ scp["name"] }} {
        all {
            {%- for param, value in scp.all.items() %}
            {%- if value | int > 0 %}
            {{ param }} {{ value }};
            {%- else %}
            {{ param }};
            {%- endif %}
            {%- endfor %}
        }
        {%- if  scp["action-shutdown"] %}
        action-shutdown;
        {%- endif %}
    }
    {%- endfor %}
    {%- endif %}
}